name: 🌐 Regenerate Translation Files

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches: [develop]
    paths:
      - 'packages/smooth_app/lib/l10n/*.arb'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  regenerate-translations:
    name: 'Regenerate Translation Files'
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: 📂 Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Get the Flutter version from ./flutter-version.txt
      - run: echo "FLUTTER_VERSION=$(cat flutter-version.txt)" >> $GITHUB_OUTPUT
        id: flutter-version

      - name: 🪺 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          cache: true
          flutter-version: ${{ steps.flutter-version.outputs.FLUTTER_VERSION }}
          cache-key: flutter-${{ hashFiles('flutter-version.txt')}}-${{ hashFiles('packages/smooth_app/pubspec.lock')}}

      - run: flutter --version

      # Get dependencies
      - name: 📦 Get dependencies
        run: |
          cd packages/smooth_app
          flutter pub get

      # Validate ARB files
      - name: 🔍 Validate ARB files
        run: |
          cd packages/smooth_app
          echo "Checking for ARB files..."
          find lib/l10n -name "*.arb" | head -5
          echo ""
          echo "Validating app_en.arb syntax..."
          python3 -c "import json; json.load(open('lib/l10n/app_en.arb'))"
          echo "✅ ARB files are valid"

      # Install intl_utils globally
      - name: 🔧 Install intl_utils
        run: |
          flutter pub global activate intl_utils
          flutter pub global list | grep intl_utils

      # Generate translation files
      - name: 🌐 Generate translation files
        run: |
          cd packages/smooth_app
          echo "Current directory: $(pwd)"
          echo "Checking l10n.yaml configuration:"
          cat l10n.yaml
          echo ""
          echo "Running intl_utils:generate..."
          flutter pub global run intl_utils:generate
          echo "Translation file generation completed successfully"

      # Check if there are any changes
      - name: 📊 Check for changes
        id: check-changes
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in generated translation files"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in generated translation files:"
            git diff --staged --name-only
            echo ""
            echo "Summary of changes:"
            git diff --staged --stat
          fi

      # Create Pull Request if there are changes
      - name: 🔀 Create Pull Request
        if: steps.check-changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: regenerate translation files'
          title: '🌐 Regenerate translation files'
          body: |
            This PR was automatically created to regenerate Flutter translation files after changes to ARB files.
            
            ## What changed
            - Translation files have been regenerated using `intl_utils:generate`
            - This ensures all generated Dart files are in sync with the ARB translation files
            
            ## Files affected
            The following generated files may have been updated:
            - `lib/l10n/app_localizations.dart`
            - `lib/l10n/app_localizations_*.dart`
            
            ## How to review
            1. Check that the generated code looks correct
            2. Verify that no manual translations were overwritten
            3. Test the app to ensure translations work properly
            
            This PR was automatically generated by the translation regeneration workflow.
          branch: auto/regenerate-translations-${{ github.run_number }}
          delete-branch: true
          labels: |
            🌐 l10n
            🤖 automated pr
          assignees: |
            ${{ github.actor }}